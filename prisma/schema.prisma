// This is your Prisma schema file.
// Docs: https://pris.ly/d/prisma-schema
// Connection URL is configured in prisma.config.ts (DATABASE_URL).

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum WorkerProcessStatus {
  INFO
  ERROR
  FAILED
  INVALID_RESPONSE
}

/** AI = only AI message reply, no edit. HUMAN_AI = someone edited the AI response. */
enum ReplyMadeBy {
  AI
  HUMAN_AI
}

model Ticket {
  id             Int      @id @default(autoincrement())
  title          String
  content        String   @db.Text
  userId         Int?     @map("user_id")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  status         TicketStatus
  category       String?
  tag            String?
  sentiment      Int?
  urgency        String?
  responseDraft  String?  @db.Text @map("response_draft")
  replyMadeBy    ReplyMadeBy? @map("reply_made_by")
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  workerProcesses WorkerProcess[]

  @@index([createdAt])
  @@index([title])
  @@index([status])
  @@index([category])
  @@index([sentiment])
  @@index([urgency])
  @@index([userId])
  @@map("tickets")
}

model WorkerProcess {
  id              Int                 @id @default(autoincrement())
  workerId        String              @map("worker_id")
  ticketId        Int                 @map("ticket_id")
  ticket          Ticket              @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  time            DateTime            @default(now())
  aiReplyMessage  String?             @db.Text @map("ai_reply_message")
  rawAiResponse   String?             @db.Text @map("raw_ai_response")
  status          WorkerProcessStatus
  errorMessage    String?             @db.Text @map("error_message")
  createdAt       DateTime            @default(now())

  @@map("worker_processes")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  roles     String[] @default(["user"])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tickets   Ticket[]

  @@map("users")
}
